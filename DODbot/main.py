from bot import bot, telebot
from flask import Flask, request, abort
import time
from telebot.apihelper import ApiTelegramException
import quiz
import set_points
import add_admin
import newsletter
import admin_handlers
import handlers
import logging


app = Flask(__name__)
app.logger.setLevel(logging.DEBUG)

@app.route('/test')
def test():
    return "Test page"

@app.route('/your-webhook-path', methods=['POST'])
def webhook():
    print("Webhook received!")
    json_str = request.get_data(as_text=True)
    print(f"Raw data: {json_str}")  # üî¥ –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—Å—Ç—É–ø–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ

    if not json_str:
        return "No data received", 400  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç

    try:
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        print(f"Error processing webhook: {e}")
        return "Failed to process update", 500

    return "OK", 200


@app.route("/your-webhook-path", methods=["GET"])
def index():
    return "Flask server is running!", 200

@app.route("/", methods=["GET"])
def home():
    return "Flask server is running!", 200

def set_webhook_with_retry():
    retries = 5
    for _ in range(retries):
        try:
            bot.set_webhook(url="https://dodbot.duckdns.org/your-webhook-path")
            print("Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
            return
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ webhook: {e}")
            time.sleep(10)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
    print("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫.")

if __name__ == '__main__':
    #bot.remove_webhook()
    try:
        bot.set_webhook(url="https://dodbot.duckdns.org/your-webhook-path")
    except ApiTelegramException as e:
        if e.result_json['error_code'] == 429:
            retry_after = e.result_json['parameters']['retry_after']
            print(f"Too many requests. Retrying after {retry_after} seconds...")
            time.sleep(1)
            bot.set_webhook(url="https://dodbot.duckdns.org/your-webhook-path")

    print(bot.get_webhook_info())

    app.run(host="0.0.0.0", port=5000, debug=True)
